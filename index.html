<!DOCTYPE HTML>
<html>
<head>
<meta charset="UTF-8">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<style>
#month_slider{
	-webkit-appearance: none;
	width:37.5%;
	height:10px;
	border-radius:2.5px;
	background:#D3D3D3;
	outline:none;
	opacity:0.7;
	padding:0;
}
#month_slider:hover{
	opacity:1;

}
#month_slider::-webkit-slider-thumb{
	-webkit-appearance:none;
	appearance:none;
	width:25px;
	height:25px;
	border-radius:50%;
	background:#FFFFFF;
	cursor: pointer;

	border:2px solid #666666;
}
#month_slider::-webkit-slider-thumb:hover{
	box-shadow:0 2px 6px rgba(0, 0, 0, 0.3);
}
.select_container{
    border:none;
    display:inline-block;
    margin-bottom:.25rem;
	padding-left:10px;
	padding-right:10px;
}
#month_year{
	font-size:1.625rem;
	font-weight:bold;
    font-family:Helvetica, Arial, sans-serif;
	
	padding-right:10px
}
.selector{
    color:#333333;
	font-size:1.625rem;
    font-family:Helvetica, Arial, sans-serif;
	
	z-index:2;
	
    border:2px solid #666666;
}
.selector:hover{
	cursor:pointer;
	box-shadow:0 2px 6px rgba(0, 0, 0, 0.3);
}
.law_content_main_content{
	margin-top:5px;
}
.law_content_time{
	color:#757575;
	font-size:0.9rem;
	font-weight:normal;
	text-align:left;
	margin:0;
}
.law_content_citation{
	color:#666666;
	font-size:1rem;
	font-weight:bold;
	text-align:left;
	margin:0;
}
.law_content_type{
	font-size:1rem;
	font-weight:bold;
	text-align:left;
}
.law_type_block{
	margin-bottom:30px;
}
.law_content_title{
	color:#000000;
	opacity:0.7;
	font-size:1.25rem;
	font-weight:bold;
	text-align:center;
}
#law_content_text{
	font-family: Helvetica,Arial,sans-serif;
	
    width:75%;
    height:31.22vw;
	
    top:7.5%;
    left:0;
	
	background-color:#D3D3D3;
	border:2px solid #666666;
	
	padding-top:15px;
	padding-bottom:15px;
	padding-left:20px;
	padding-right:20px;
	
	overflow-x:hidden;
	overflow-y:auto;
}
#law_content_text::-webkit-scrollbar-track{
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
	border-radius:5px;
	background-color:#F5F5F5;
}
#law_content_text::-webkit-scrollbar{
	width:10px;
	background-color:#F5F5F5;
}
#law_content_text::-webkit-scrollbar-thumb{
	border-radius:5px;
	-webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
	background-color:#A6A6A6;
}
#law_content_text::-webkit-scrollbar-thumb:hover{
	background-color:#757575;
}
#law_content_text_container{
	width:50%;

	left:50%;
	float:left;
	user-select:text;
}
.selected_state{
	fill:#FCBA03 !important;
	fill-opacity:1 !important;
}
.state_map:hover{
	cursor:pointer;	
}
#law_map_chart{
	width:50%;
	
	left:0%;
	float:left;
}
#law_content_container{
	width:92.5%;
	left:7.5%;
	position:relative;
	
	display:inline-block;
	user-select:none;
}
#law_title_container{
	width:85%;
	
	left:7.5%;
	position:relative;
	
    color:#333333;
	font-size:1.625rem;
    font-family:Helvetica,Arial,sans-serif;
	
	line-height:1.2;
    margin:0 0 .5rem;
}
#law_map_container{
	width:100vw;
	height:100vh;
	
	left:0%;
	position:relative;
	
	overflow:hidden;
	
	font-family:Helvetica,Arial,sans-serif;
}
#overview_map_chart{
	width:50%;
	
	left:0%;
	float:left;
}
#overview_content_container{
	width:92.5%;
	left:7.5%;
	position:relative;
	
	display:inline-block;
	user-select:none;
}
#year_slider{
	-webkit-appearance: none;
	width:37.5%;
	height:10px;
	border-radius:2.5px;
	background:#D3D3D3;
	outline:none;
	opacity:0.7;
	padding:0;
}
#year_slider:hover{
	opacity:1;

}
#year_slider::-webkit-slider-thumb{
	-webkit-appearance:none;
	appearance:none;
	width:25px;
	height:25px;
	border-radius:50%;
	background:#FFFFFF;
	cursor: pointer;

	border:2px solid #666666;
}
#year_slider::-webkit-slider-thumb:hover{
	box-shadow:0 2px 6px rgba(0, 0, 0, 0.3);
}
#overview_title_container{
	width:85%;
	
	left:7.5%;
	position:relative;
	
    color:#333333;
	font-size:1.625rem;
    font-family:Helvetica,Arial,sans-serif;
	
	line-height:1.2;
    margin:0 0 .5rem;
}
#overview_container{
	width:100vw;
	height:100vh;
	
	left:0%;
	position:relative;
	
	overflow:hidden;
	
	font-family:Helvetica,Arial,sans-serif;
}
body{
	margin:0;
	overflow-x:hidden;
}
</style>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>
<div id="overview_container">
	<div id="overview_title_container"></div>
	<div id="overview_content_container">
		<svg id="overview_map_chart"></svg>
	</div>
</div>
<div id="law_map_container">
	<div id="law_title_container"></div>
	<div id="law_content_container">
		<svg id="law_map_chart"></svg>
		<div id="law_content_text_container">
			<div id="law_content_text">
				<p class="law_content_title" style="opacity:0.5;">
					please click on the state to view the laws of state
				</p>
			</div>
		</div>
	</div>
</div>
</body>
<script type="text/javascript">
	var law_type = [
		{
			"type_name":"background checks",
			"has_gun_type":true,
			"gun_type":[
				"handguns",
				"long guns"
			],
			"law_degree_checking":false,
			"restrict_degree":[
				{
					"key_name":"Background checks for sales from dealers – Federal",
					"connect_symbol":"–"
				},
				{
					"key_name":"Background checks for sales from dealers",
					"connect_symbol":"-"
				},
				{
					"key_name":"Background checks for private sales",
					"connect_symbol":"-"
				},
				{
					"key_name":"Permit to Purchase",
					"connect_symbol":"-"
				}
			],
			"degree_title":[
				["Background checks", "for sales from", "dealers – Federal"],
				["Background checks", "for sales from", "dealers only"],
				["Background checks", "for private sales"],
				["Background checks", "for permits to", "purchase"]
			],
			"color":[
				"#C8C8C8",
				"#8F9CD9",
				"#5670EB",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws on the purchase of",
				"end":""
			},
			"score_accumulate":false,
			"safety_score":[
				0,
				5,
				10,
				15
			]
		},
		{
			"type_name":"registration",
			"has_gun_type":true,
			"gun_type":[
				"handguns",
				"long guns"
			],
			"law_degree_checking":true,
			"restrict_degree":[
				{
					"key_name":"Registration",
					"connect_symbol":"-"
				}
			],
			"degree_title":[
				["None"],
				["Registration"]
			],
			"color":[
				"#C8C8C8",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws on the type of",
				"end":""
			},
			"score_accumulate":false,
			"safety_score":[
				0,
				10
			]
		},
		{
			"type_name":"carrying a concealed weapon",
			"has_gun_type":false,
			"law_degree_checking":false,
			"restrict_degree":[
				{
					"key_name":"Carrying a concealed weapon (CCW) - shall issue (permit not required)"
				},
				{
					"key_name":"Carrying a concealed weapon (CCW) - shall issue"
				},
				{
					"key_name":"Carrying a concealed weapon (CCW) - may issue"
				},
				{
					"key_name":"Carrying a concealed weapon (CCW) - prohibited"
				}
			],
			"degree_title":[
				["Permit not required"],
				["Shall issue"],
				["May issue"],
				["Prohibited"]
			],
			"color":[
				"#C8C8C8",
				"#8F9CD9",
				"#5670EB",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws",
				"end":""
			},
			"score_accumulate":false,
			"safety_score":[
				-5,
				5,
				10,
				15
			]
		},
		{
			"type_name":"open carrying",
			"has_gun_type":true,
			"gun_type":[
				"handguns",
				"long guns"
			],
			"law_degree_checking":false,
			"restrict_degree":[
				{
					"key_name":"Open Carry not restricted",
					"connect_symbol":"-"
				},
				{
					"key_name":"Open Carry limited",
					"connect_symbol":"-"
				},
				{
					"key_name":"Open Carry license required",
					"connect_symbol":"-"
				},
				{
					"key_name":"Open Carry prohibited",
					"connect_symbol":"-"
				}
			],
			"degree_title":[
				["Not restricted"],
				["Limited"],
				["License required"],
				["Prohibited"]
			],
			"color":[
				"#C8C8C8",
				"#8F9CD9",
				"#5670EB",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws on the type of",
				"end":""
			},
			"score_accumulate":false,
			"safety_score":[
				-10,
				5,
				10,
				15
			]
		},
		{
			"type_name":"castle doctrine",
			"has_gun_type":false,
			"law_degree_checking":false,
			"restrict_degree":[
				{
					"key_name":"Castle Doctrine - Stand Your Ground"
				},
				{
					"key_name":"Castle Doctrine - Expanded"
				},
				{
					"key_name":"Castle Doctrine"
				}
			],
			"degree_title":[
				["Stand Your Ground"],
				["Expanded"],
				["Castle Doctrine"]
			],
			"color":[
				"#C8C8C8",
				"#7286E2",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws",
				"end":""
			},
			"score_accumulate":false,
			"safety_score":[
				-5,
				0,
				5
			]
		},
		{
			"type_name":"firearm ban",
			"has_gun_type":false,
			"law_degree_checking":false,
			"restrict_degree":[
				{
					"key_name":"Firearm Ban"
				},
				{
					"key_name":"Firearm Ban - Saturday Night Special Ban"
				},
				{
					"key_name":"Firearm Ban - Assault Weapon Ban (handguns)"
				},
				{
					"key_name":"Firearm Ban - Assault Weapon Ban (long guns)"
				}
			],
			"degree_title":[
				["None"],
				["Saturday night", "special ban"],
				["Assault weapon", "ban — handguns"],
				["Assault weapon", "ban — long guns"]
			],
			"color":[
				"#C8C8C8",
				"#8F9CD9",
				"#5670EB",
				"#1D44FD"
			],
			"law_title":{
				"start":"states have",
				"middle":"laws",
				"end":""
			},
			"score_accumulate":true,
			"safety_score":[
				0,
				5,
				10,
				10
			]
		}
	];
	
	/*
	var safety_rank_color = [
		"#FFA723", "#F4AD44",
		"#E9B465", "#DEBA86",
		"#D3C1A7", "#C8C8C8"
	];
	*/
	
	// month slider
	var month_start = 1;
	var month_end = 72;
	var selected_month = 72;
	
	const month_name = [
		"Jan", "Feb",
		"Mar", "Apr",
		"May", "Jun",
		"Jul", "Aug",
		"Sep", "Oct",
		"Nov", "Dec"
	];
	var selected_law_idx;
	var selected_gun_idx;
	
	// overview map variables
	var overview_map_svg;
	var overview_map_g;
	var overview_map_legend_g;
	var overview_width = 960;
	var overview_height = 600;
	var score_scale_color;
	
	// year selector for overview
	var year_start = 1;
	var year_end = 6;
	var selected_year = 6
	var selected_overview_idx;
	
	// chart variables
	var law_map_svg;
	var law_map_g;
	var law_legend_g;
	var width = 960;
	var height = 600;
	
	/* 
		law_data: a two level dictionary
			first level key: 
				name of state
			second level key:
				type of law
			value:
				law				
	*/
	var law_state = {};
	
	// calculate score for overview
	// id = overview_stateName
	function calculate_score(id){
		var state = id.replace("overview_", "");
		var state_laws = law_state[state];
		
		var current_time = new Date(2014+parseInt(selected_year), 0, 1);
		var safety_score = 0;

		for(var i = 0; i < law_type.length; ++i){
			var current_law_type = law_type[i];
			
			if(current_law_type["score_accumulate"]){
				if(current_law_type["has_gun_type"]){
					for(j = 0; j < current_law_type["gun_type"].length; ++j){
						var current_gun_type = current_law_type["gun_type"][j];
						var search_key;
						
						for(k = 0; k < current_law_type["restrict_degree"].length; ++k){
							search_key = current_law_type["restrict_degree"][k]["key_name"] + " " + current_law_type["restrict_degree"][k]["connect_symbol"] + " " + current_gun_type;
							var latest_law = null;
							var latest_date = new Date(-8640000000000000);
							
							if(search_key in state_laws){
								for(var l = 0; l < state_laws[search_key].length; ++l){
									var law = state_laws[search_key][l];
									
									// check whether the law had been supressed
									if(law["Supercession Date"] != ""){
										var supressed_date = new Date(law["Supercession Date"]);
										
										if(current_time.getTime() > supressed_date.getTime()){
											continue;
										}
									}
									
									// check whether the law is effected
									if(law["Effective Date"] != ""){
										var effective_date = new Date(law["Effective Date"]);
										
										if(current_time.getTime() >= effective_date.getTime()){
											if(effective_date.getTime() > latest_date.getTime()){
												latest_date = effective_date;
												latest_law = law;
											}
										}
									}
									else{
										continue;
									}
								}
							}
							else{
								continue;
							}
							
							if(latest_law != null){
								if(current_law_type["law_degree_checking"]){
									safety_score += current_law_type["safety_score"][k+1];
								}
								else{
									safety_score += current_law_type["safety_score"][k];
								}
							}
						}
					}
				}
				else{
					var search_key;
					
					for(j = 0; j < current_law_type["restrict_degree"].length; ++j){
						search_key = current_law_type["restrict_degree"][j]["key_name"];
						var latest_law = null;
						var latest_date = new Date(-8640000000000000);
						
						if(search_key in state_laws){
							for(var k = 0; k < state_laws[search_key].length; ++k){
								var law = state_laws[search_key][k];
								
								// check whether the law had been supressed
								if(law["Supercession Date"] != ""){
									var supressed_date = new Date(law["Supercession Date"]);
									
									if(current_time.getTime() > supressed_date.getTime()){
										continue;
									}
								}
								
								// check whether the law is effected
								if(law["Effective Date"] != ""){
									var effective_date = new Date(law["Effective Date"]);
									
									if(current_time.getTime() >= effective_date.getTime()){
										if(effective_date.getTime() > latest_date.getTime()){
											latest_date = effective_date;
											latest_law = law;
										}
									}
								}
								else{
									continue;
								}
							}
						}
						else{
							continue;
						}
						
						if(latest_law != null){
							if(current_law_type["law_degree_checking"]){
								safety_score += current_law_type["safety_score"][j+1];
							}
							else{
								safety_score += current_law_type["safety_score"][j];
							}
						}
					}
				}
			}
			else{
				if(current_law_type["has_gun_type"]){
					for(j = 0; j < current_law_type["gun_type"].length; ++j){
						var current_gun_type = current_law_type["gun_type"][j];
						var max_degree = 0;
						var search_key;
						
						for(k = 0; k < current_law_type["restrict_degree"].length; ++k){
							search_key = current_law_type["restrict_degree"][k]["key_name"] + " " + current_law_type["restrict_degree"][k]["connect_symbol"] + " " + current_gun_type;
							var latest_law = null;
							var latest_date = new Date(-8640000000000000);
							
							if(search_key in state_laws){
								for(var l = 0; l < state_laws[search_key].length; ++l){
									var law = state_laws[search_key][l];
									
									// check whether the law had been supressed
									if(law["Supercession Date"] != ""){
										var supressed_date = new Date(law["Supercession Date"]);
										
										if(current_time.getTime() > supressed_date.getTime()){
											continue;
										}
									}
									
									// check whether the law is effected
									if(law["Effective Date"] != ""){
										var effective_date = new Date(law["Effective Date"]);
										
										if(current_time.getTime() >= effective_date.getTime()){
											if(effective_date.getTime() > latest_date.getTime()){
												latest_date = effective_date;
												latest_law = law;
											}
										}
									}
									else{
										continue;
									}
								}
							}
							else{
								continue;
							}
							
							if(latest_law != null){
								if(current_law_type["law_degree_checking"]){
									max_degree = k + 1;
								}
								else{
									if(k > max_degree){
										max_degree = k;
									}
								}
							}
						}
						
						safety_score += current_law_type["safety_score"][max_degree];
					}
				}
				else{
					var max_degree = 0;
					var search_key;
					
					for(j = 0; j < current_law_type["restrict_degree"].length; ++j){
						search_key = current_law_type["restrict_degree"][j]["key_name"];
						var latest_law = null;
						var latest_date = new Date(-8640000000000000);
						
						if(search_key in state_laws){
							for(var k = 0; k < state_laws[search_key].length; ++k){
								var law = state_laws[search_key][k];
								
								// check whether the law had been supressed
								if(law["Supercession Date"] != ""){
									var supressed_date = new Date(law["Supercession Date"]);
									
									if(current_time.getTime() > supressed_date.getTime()){
										continue;
									}
								}
								
								// check whether the law is effected
								if(law["Effective Date"] != ""){
									var effective_date = new Date(law["Effective Date"]);
									
									if(current_time.getTime() >= effective_date.getTime()){
										if(effective_date.getTime() > latest_date.getTime()){
											latest_date = effective_date;
											latest_law = law;
										}
									}
								}
								else{
									continue;
								}
							}
						}
						else{
							continue;
						}
						
						if(latest_law != null){
							if(current_law_type["law_degree_checking"]){
								max_degree = k + 1;
							}
							else{
								if(k > max_degree){
									max_degree = k;
								}
							}
						}
					}
					
					safety_score += current_law_type["safety_score"][max_degree];
				}
			}
		}

		$("[id='"+id+"']").data("safety_score", safety_score);
		
		return safety_score;
	}
	
	function score_ranking(score){
		if(score >= 96 && score <= 120){
			return 0;
		}
		else if(score >= 71 && score <= 95){
			return 1;
		}
		else if(score >= 46 && score <= 70){
			return 2;
		}
		else if(score >= 21 && score <= 45){
			return 3;
		}
		else if(score >= -4 && score <= 20){
			return 4;
		}
		else{
			return 5;
		}
	}
	
	function show_overview_map_legend(){
		overview_map_legend_g.html("");
		
		var g = overview_map_legend_g.append("g")
			.attr("class", "overview_map_legend_cell")
			.attr("transform", "translate(10, 5)");
			
		var text = g.append("text")
			.attr("class", "law_map_legend_text")
			.attr("transform", "translate(0, 46)")
			.style("font-size", "1.25em");
			
		text.append("tspan")
			.attr("x", 312.5)
			.attr("dy", 0)
			.text("Loose");
			
		text.append("tspan")
			.attr("x", 640)
			.attr("dy", 0)
			.text("Restrictive");
			
			
		var arr = d3.range(251);
		
		var legend_scale = d3.scaleLinear()
			.domain([0, 250])
			.range([-30, 120]);
	
		g.selectAll('rect')
			.data(arr)
			.enter()
			.append('rect')
			.attr("x", function(d){ return 375+d; })
			.attr("y", 30)
			.style("width", 5)
			.style("height", 20)
			.style("fill", function(d){ return score_scale_color(legend_scale(d));});
	}
	
	function update_map(id){
		var state = id;
		var state_laws = law_state[state];
		
		var current_time = new Date(2014, selected_month, 1);
		var current_law_type = law_type[selected_law_idx];
		var current_gun_type;
		
		var max_degree = 0;
		var active_law = [];
		var active_degree = []
		
		if(current_law_type["law_degree_checking"]){
			if(current_law_type["has_gun_type"]){
				current_gun_type = current_law_type["gun_type"][selected_gun_idx];
				var search_key;
				
				for(var i = 0; i < current_law_type["restrict_degree"].length; ++i){
					search_key = current_law_type["restrict_degree"][i]["key_name"] + " " + current_law_type["restrict_degree"][i]["connect_symbol"] + " " + current_gun_type;
					var latest_law = null;
					var latest_date = new Date(-8640000000000000);
					
					if(search_key in state_laws){
						for(var j = 0; j < state_laws[search_key].length; ++j){
							var law = state_laws[search_key][j];
							
							// check whether the law had been supressed
							if(law["Supercession Date"] != ""){
								var supressed_date = new Date(law["Supercession Date"]);
								
								if(current_time.getTime() > supressed_date.getTime()){
									continue;
								}
							}
							
							// check whether the law is effected
							if(law["Effective Date"] != ""){
								var effective_date = new Date(law["Effective Date"]);
								
								if(current_time.getTime() >= effective_date.getTime()){
									if(effective_date.getTime() > latest_date.getTime()){
										latest_date = effective_date;
										latest_law = law;
									}
								}
							}
							else{
								continue;
							}
						}									
					}
					else{
						continue;
					}
					
					if(latest_law != null){
						max_degree = i + 1;
						active_law.push(latest_law);
						active_degree.push(max_degree);
					}
				}
			}
			else{
				for(var i = 0; i < current_law_type["restrict_degree"].length; ++i){
					search_key = current_law_type["restrict_degree"][i]["key_name"];
					var latest_law = null;
					var latest_date = new Date(-8640000000000000);
					
					if(search_key in state_laws){
						for(var j = 0; j < state_laws[search_key].length; ++j){
							var law = state_laws[search_key][j];
							
							// check whether the law had been supressed
							if(law["Supercession Date"] != ""){
								var supressed_date = new Date(law["Supercession Date"]);
								
								if(current_time.getTime() > supressed_date.getTime()){
									continue;
								}
							}
							
							// check whether the law is effected
							if(law["Effective Date"] != ""){
								var effective_date = new Date(law["Effective Date"]);
								
								if(current_time.getTime() >= effective_date.getTime()){
									if(effective_date.getTime() > latest_date.getTime()){
										latest_date = effective_date;
										latest_law = law;
									}
								}
							}
							else{
								continue;
							}
						}									
					}
					else{
						continue;
					}
					
					if(latest_law != null){
						max_degree = i + 1;
						active_law.push(latest_law);
						active_degree.push(max_degree);
					}
				}
			}
		}
		else{
			if(current_law_type["has_gun_type"]){
				current_gun_type = current_law_type["gun_type"][selected_gun_idx];
				var search_key;
				
				for(var i = 0; i < current_law_type["restrict_degree"].length; ++i){
					search_key = current_law_type["restrict_degree"][i]["key_name"] + " " + current_law_type["restrict_degree"][i]["connect_symbol"] + " " + current_gun_type;
					var latest_law = null;
					var latest_date = new Date(-8640000000000000);

					if(search_key in state_laws){
						for(var j = 0; j < state_laws[search_key].length; ++j){
							var law = state_laws[search_key][j];
							
							// check whether the law had been supressed
							if(law["Supercession Date"] != ""){
								var supressed_date = new Date(law["Supercession Date"]);
								
								if(current_time.getTime() > supressed_date.getTime()){
									continue;
								}
							}
							
							// check whether the law is effected
							if(law["Effective Date"] != ""){
								var effective_date = new Date(law["Effective Date"]);
								
								if(current_time.getTime() >= effective_date.getTime()){
									if(effective_date.getTime() > latest_date.getTime()){
										latest_date = effective_date;
										latest_law = law;
									}
								}
							}
							else{
								continue;
							}
						}									
					}
					else{
						continue;
					}
					
					if(latest_law != null){
						if(i > max_degree){
							max_degree = i;
						}
						active_law.push(latest_law);
						active_degree.push(i);
					}
				}	
			}
			else{
				var search_key;
				
				for(var i = 0; i < current_law_type["restrict_degree"].length; ++i){
					search_key = current_law_type["restrict_degree"][i]["key_name"];
					var latest_law = null;
					var latest_date = new Date(-8640000000000000);
					
					if(search_key in state_laws){
						for(var j = 0; j < state_laws[search_key].length; ++j){
							var law = state_laws[search_key][j];
							
							// check whether the law had been supressed
							if(law["Supercession Date"] != ""){
								var supressed_date = new Date(law["Supercession Date"]);
								
								if(current_time.getTime() > supressed_date.getTime()){
									continue;
								}
							}
							
							// check whether the law is effected
							if(law["Effective Date"] != ""){
								var effective_date = new Date(law["Effective Date"]);
								if(current_time.getTime() >= effective_date.getTime()){
									if(effective_date.getTime() > latest_date.getTime()){
										latest_date = effective_date;
										latest_law = law;
									}
								}
							}
							else{
								continue;
							}
						}
					}
					else{
						continue;
					}
					
					if(latest_law != null){
						if(i > max_degree){
							max_degree = i;
						}
						active_law.push(latest_law);
						active_degree.push(i);
					}
				}
			}
		}
		
		$("[id='"+state+"']").data("degree", max_degree);
		$("[id='"+state+"']").data("active_law", active_law);
		$("[id='"+state+"']").data("active_degree", active_degree);
		
		return current_law_type["color"][max_degree];
	}
	
	function show_law_map_legend(){
		law_legend_g.html("");

		var current_law_type = law_type[selected_law_idx];
		var current_gun_type;
		
		for(var i = 0; i < current_law_type["degree_title"].length; ++i){
			var g = law_legend_g.append("g")
				.attr("class", "law_map_legend_cell")
				.attr("transform", "translate("+(7 + 150*i)+", 5)");
				
			g.append("rect")			
				.attr("class", "law_map_legend_rect")
				.attr("width", 25)
				.attr("height", 15)
				.attr("fill", current_law_type["color"][i]);
				
			var text = g.append("text")
				.attr("class", "law_map_legend_text")
				.attr("transform", "translate(0, 33)")
				.style("font-size", "15px");
				
			for(var j = 0; j < current_law_type["degree_title"][i].length; ++j){
				text.append("tspan")
					.attr("x", 0)
					.attr("dy", function(){ return (j == 0)? 0+"em":1+"em";})
					.text(current_law_type["degree_title"][i][j]);
			}
		}
	}
	
	function show_law_content_text(){
		if($(".selected_state").length){
			var state_id = $(".selected_state")[0].id;
			var degree = $("[id='"+state_id+"']").data("degree");
			var active_laws = $("[id='"+state_id+"']").data("active_law");
			var active_degree = $("[id='"+state_id+"']").data("active_degree");
			var current_time = new Date(2014, selected_month-1, 1);
			console.log(active_laws);
			if(active_laws.length > 0){
				var html_content = "";
				
				html_content +=
					"<p class='law_content_title'>"+
						state_id + "&nbsp;laws in effect in&nbsp;"+
						current_time.getFullYear() + "&nbsp;" + month_name[current_time.getMonth()]+
					"</p>"+
					"<div class='law_content_block'>";
				
				for(var i = active_laws.length-1; i >= 0; --i){
					var degree_title = "";
					
					for(var j = 0; j < law_type[selected_law_idx]["degree_title"][active_degree[i]].length; ++j){
						if(j != 0){
							degree_title += "&nbsp;";
						}
						degree_title += law_type[selected_law_idx]["degree_title"][active_degree[i]][j];
					}
					
					var effected_date = active_laws[i]["Effective Date Year"] + "-" + active_laws[i]["Effective Date Month"] + "-" + active_laws[i]["Effective Date Day"];
					var supressed_date;
					
					if(active_laws[i]["Supercession Date"] == ""){
						supressed_date = "Present";
					}
					else{
						var sup_date = new Date(active_laws[i]["Supercession Date"])
						
						supressed_date = sup_date.getFullYear() + "-" + sup_date.getMonth()+1 + "-" + sup_date.getDate();
					}
							
					html_content +=
						"<div class='law_type_block'>"+
							"<p class='law_content_type'>"+
								degree_title+
							"</p>"+
							"<p class='law_content_citation'>"+
								active_laws[i]["Statutory Citation"]+
							"</p>"+
							"<p class='law_content_time'>"+
								"Active from&nbsp;" + effected_date + "&nbsp;~&nbsp;" + supressed_date+
							"</p>"+
							"<p class='law_content_main_content'>"+
								active_laws[i]["Content"].replace(/\?/g, '')+
							"</p>"+
						"</div>";
				}
				
				html_content += "</div>";
				
				$("#law_content_text").html(html_content);
			}
			else{
				$("#law_content_text").html(
					"<p class='law_content_title'>"+
						"Np&nbsp;" + state_id + "&nbsp;law is effective in&nbsp;" +
						current_time.getFullYear() + "&nbsp;" + month_name[current_time.getMonth()]+
					"</p>"
				);
			}
		}
		else{
			$("#law_content_text").html(
				"<p class='law_content_title' style='opacity:0.5;'>"+
					"please click on the state to view the laws of state"+
				"</p>"
			);
		}
	}
	
	$(document).ready(function() {
		selected_year = 6;
		selected_overview_idx = 0;
		
		overview_map_svg = d3.select("#overview_map_chart")
			.attr("preserveAspectRatio", "xMinYMin meet")
			.attr("viewBox", "0 0 800 720");
		
		overview_map_g = overview_map_svg.append("g")
			.attr("transform", "translate(-100, 50)");
			
		overview_map_legend_g = overview_map_svg.append("g");
		
		selected_month = 72;
		selected_law_idx = 0;
		selected_gun_idx = 0;
		
		law_map_svg = d3.select("#law_map_chart")
			.attr("preserveAspectRatio", "xMinYMin meet")
			.attr("viewBox", "0 0 800 720");
		
		law_map_g = law_map_svg.append("g")
			.attr("transform", "translate(-100, 50)");
		law_legend_g = law_map_svg.append("g");

		d3.csv("./data/State Firearm Law.csv", function(law_data){
			
			// data using state as first key and type of law as second key
			var temp_data = d3.nest()
				.key(function(d){ return d["State"];})
				.entries(law_data);
			
			temp_data.forEach(function(d){
				var key = d.key;
				
				if (!(key in law_state)){
					law_state[key] = {};
				}
				
				for(var idx in d.values){
					var type = d.values[idx]["Type of Law"];

					if (type in law_state[key]){
						law_state[key][type].push(d.values[idx]);
					}
					else{
						law_state[key][type] = [];
						law_state[key][type].push(d.values[idx]);
					}
				}
			});
			
			console.log(law_state);
			
			var law_type_of_law = d3.nest()
				.key(function(d){ return d["Type of Law"];})
				.entries(law_data);
			
			console.log(law_type_of_law)

			var overview_projection = d3.geoAlbersUsa()
				.translate([overview_width/2, overview_height/2])
				.scale([1000]);   

			var overview_path = d3.geoPath()
			  .projection(overview_projection);
			
			// color for overview score
			score_scale_color = d3.scaleLinear()
				.domain([-30, 0, 120])
				.range(["#B80000", "#FFA700", "#A3C800"])
				.interpolate(d3.interpolateRgb);
			
			// D3 Projection
			var projection = d3.geoAlbersUsa()
				.translate([width/2, height/2])
				.scale([1000]);   

			var path = d3.geoPath()
			  .projection(projection);

			// drawing us map
			d3.json("./data/us-states.json", function(json) {
				// draw overview map
				overview_map_g.selectAll("path")
					.data(json.features)
					.enter()
					.append("path")
					.attr("d", overview_path)
					.attr("id", function(d){ return "overview_" + d["properties"]["NAME"];})
					.classed("overview_state_map", true)
					.style("stroke", "#FFFFFF")
					.style("stroke-width", "1")
					.style("fill", function(d){
						var id = this.id;
						
						var score = calculate_score(id);					
						
						return score_scale_color(score);
					});
			
				show_overview_map_legend();
				
				
				// draw law map
				law_map_g.selectAll("path")
					.data(json.features)
					.enter()
					.append("path")
					.attr("d", path)
					.attr("id", function(d){ return d["properties"]["NAME"];})
					.classed("state_map", true)
					.style("stroke", "#FFFFFF")
					.style("stroke-width", "1")
					.style("fill", function(d){
						var state = this.id;
						
						return update_map(state);
					})
					.on("mouseover", function(d){
						var state = this.id;
						
						if(d3.select("[id='"+state+"']").classed("selected_state")){
						
						}
						else{
							d3.select("[id='"+state+"']")
								.style("fill-opacity", "0.75");
						}

					})
					.on("mouseleave", function(){
						var state = this.id;
						
						if(d3.select("[id='"+state+"']").classed("selected_state")){
						
						}
						else{
							d3.select("[id='"+state+"']")
								.style("fill-opacity", "1");
						}
					})
					.on("click", function(){
						var state = this.id;

						if(d3.select("[id='"+state+"']").classed("selected_state")){
							d3.select("[id='"+state+"']")
								.classed("selected_state", false);
						}
						else{
							d3.select("[id='"+state+"']")
								.classed("selected_state", true);
						}
						
						d3.selectAll(".selected_state")
							.classed("selected_state", function(){
								if(this.id != state){
									return false;
								}
								else{
									return true;
								}
							});
							
						show_law_content_text();
					});
			});

			show_law_map_legend();
		});
		
		$("#overview_title_container").html(
			"<p id='overview_title'>"+
				"<span id='overview_title_text'>"+
					"Gun Law Overview –&nbsp;"+
				"</span>"+
				"<span id='overview_title_year'>"+
					"2019"+
				"</span>"+
			"</p>"+
			"<input id='year_slider' type='range' min='" + year_start + "' max='" + year_end + "' value='" + year_end + "'/>"
		);
		
		$("#law_title_container").html(
			"<p id='law_title'>"+
				"<span id='month_year'>"+
					"2019 Dec:"+
				"</span>"+
				"<span id='law_title_text_start'>"+
					"states have"+
				"</span>"+
				"<span class='select_container'>"+
					"<select name='law_type_selector' class='selector' id='law_type_selector'>"+
						"<option value='0' selected>"+
							"background checks"+
						"</option>"+
						"<option value='1'>"+
							"registration"+
						"</option>"+
						"<option value='2'>"+
							"carrying a concealed weapon"+
						"</option>"+
						"<option value='3'>"+
							"open carrying"+
						"</option>"+							
						"<option value='4'>"+
							"stand your ground"+
						"</option>"+
						"<option value='5'>"+
							"firearm ban"+
						"</option>"+
					"</select>"+
				"</span>"+
				"<span id='law_title_text_middle'>"+
					"laws on the purchase of"+
				"</span>"+
				"<span class='select_container'>"+
					"<select name='gun_type_selector' class='selector' id='gun_type_selector'>"+
						"<option value='0' selected>"+
							"handguns"+
						"</option>"+
						"<option value='1'>"+
							"long guns"+
						"</option>"+
					"</select>"+
				"</span>"+
				"<span id='law_title_text_end'>"+
				"</span>"+
			"</p>"+
			"<input id='month_slider' type='range' min='" + month_start + "' max='" + month_end + "' value='" + month_end + "'/>"
		);
		
		$("#year_slider").on("input", function(){
			selected_year = $(this).val();
			var year = parseInt(selected_year) + 2013;
			
			$("#overview_title_year").html(year);

			d3.selectAll(".overview_state_map").each(function(){
				var id = d3.select(this).attr("id");

				d3.select(this).style("fill", function(d){
					var score = calculate_score(id);
					
					return score_scale_color(score);
				});
				
				console.log($("[id='"+id+"']").data("safety_score"));
			});
		});
		
		$("#month_slider").on("input", function(){
			selected_month = $(this).val();
			var month_year = new Date(2014, selected_month-1, 1);
			$("#month_year").html(
				month_year.getFullYear() +
				" "+
				month_name[month_year.getMonth()]+
				": "
			);
			
			d3.selectAll(".state_map").each(function(){
				var id = d3.select(this).attr("id");
				
				d3.select(this).style("fill", update_map(id));
			});
			
			show_law_content_text();
		});
		
		$("#law_type_selector").on("change", function(){
			selected_law_idx = this.value;
			
			$("#law_title_text_start").html(
				law_type[selected_law_idx]["law_title"]["start"]
			);
			
			$("#law_title_text_middle").html(
				law_type[selected_law_idx]["law_title"]["middle"]
			);
			
			$("#law_title_text_end").html(
				law_type[selected_law_idx]["law_title"]["end"]
			);
			
			if(law_type[selected_law_idx]["has_gun_type"]){
				if($("#gun_type_selector").is(":hidden")){
					selected_gun_idx = 0;
					$("#gun_type_selector").val('0');
					$("#gun_type_selector").show();
				}
			}
			else{
				if($("#gun_type_selector").is(":visible")){
					$("#gun_type_selector").hide();
				}
			}
			
			d3.selectAll(".state_map").each(function(){
				var id = d3.select(this).attr("id");
				
				d3.select(this).style("fill", update_map(id));
			});

			show_law_map_legend();
			show_law_content_text();
		});
		
		$("#gun_type_selector").on("change", function(){
			selected_gun_idx = this.value;
			
			d3.selectAll(".state_map").each(function(){
				var id = d3.select(this).attr("id");
				
				d3.select(this).style("fill", update_map(id));
			});
			
			show_law_map_legend();
			show_law_content_text();
		});
	});

</script>
</html>